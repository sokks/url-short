<html>
<head profile="http://www.w3.org/2005/10/profile">
	<title>Url Shortener</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width"/>

	<meta itemprop="name" content="Сокращатель ссылок"/>
	<meta itemprop="description" content="ня"/>

	<link rel="icon" 
      type="image/png" 
      href="/img/favicon.png" />
	<link rel="preload" href="/css/new.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
	<noscript><link rel="stylesheet" href="/css/new.css"></noscript>

	<script src="/js/loadCSS/src/loadCSS.js"></script>
	<script>
		loadCSS("/css/new.css");
	</script>
</head>
	<body>
		<main>
			<div class="form-c">
			<!-- <form action="/s/new" method="post" name="urlform">
				url: <input type="text" name="url">
				<input type="submit" value="Shorten!">
			</form> -->
			</div>
			<section class="shortener">
				<div class="form-div">
					<form id="form-id">
						<!-- <input type="text" name="urlform" id="urlform-id"> -->
						<textarea rows="10" cols="20" wrap="hard" placeholder="Ваша длинная ссылка" name="urlform" id="urlform-id"></textarea>
						<button id="urlform-button-id"><span class="button-text">Укоротить!</span></button>
					</form>
				</div>
				<div class="result-div" id="result-id">
				</div>

			</section>
		</main>
		<footer class="hidden">
			FOOTER
		</footer>

		<script>
			window.addEventListener("DOMContentLoaded", function () {
				var form = document.getElementById("form-id");
				document.getElementById("urlform-button-id").addEventListener("click", function (event) {
					event.preventDefault();
					if (document.getElementById("urlform-id").value.trim() === "") {
						alert("empty url!");
						// todo: highlight input field with red
						return;
					}
					submitForm();
				});
			});

			function submitForm() {
				var url = document.getElementById("urlform-id").value
				sendNewRequest(url, processResponse);
			}

			function sendNewRequest(url, callback) {
				var resp = null;

				var xhr = new XMLHttpRequest();
				xhr.responseType = 'json';
				xhr.open("POST", "https://exler.xyz/s/new", true);
				xhr.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				var params = "url=" + encodeURIComponent(url);
				xhr.onload = function() {
					if (xhr.status != 200) { 
						console.log(xhr.status + ': ' + xhr.statusText);
						var explaination = document.createElement("p");
						explaination.appendChild(document.createTextNode("Ошибка сети :("));
						replaceResultHTML(explaination);
					} else {
						var jsonResponse = xhr.response;
						callback(jsonResponse);
					}
				}
				xhr.onerror = function() {
					console.log("error!");
					var explaination = document.createElement("p");
					explaination.appendChild(document.createTextNode("Ошибка сети :("));
					replaceResultHTML(explaination);
				}
				xhr.send(params);
			}

			function replaceResultHTML(data) {
				var divContainer = document.getElementById("result-id");
				divContainer.innerHTML = "";
				divContainer.appendChild(data);
			}

			function processResponse(jsonData) {
				var explaination = document.createElement("p");
				explaination.appendChild(document.createTextNode("Ваша короткая ссылка: " + jsonData.short));
				// todo: copy to clipboard button
				explaination.appendChild(document.createElement("br"));
				replaceResultHTML(explaination);
			}
		</script>

	</body>
</html>